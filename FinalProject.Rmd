---
title: "Final"
output: html_document
date: "2025-05-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
library(ggplot2)
library(dplyr) 
# Step 1: Load the data
data <- read.csv("cox-violent-parsed_filt.csv")

# Step 2: Clean and standardize sex column
data$sex <- trimws(tolower(data$sex))  # Remove spaces and standardize to lowercase
data$sex[data$sex == "male"] <- "Male"
data$sex[data$sex == "female"] <- "Female"

# Step 3: Keep only Male and Female rows
data <- data[data$sex %in% c("Male", "Female"), ]

# Step 4: Parse datetime columns
data$jail_in <- as.POSIXct(data$c_jail_in, format="%m/%d/%Y %H:%M")
data$jail_out <- as.POSIXct(data$c_jail_out, format="%m/%d/%Y %H:%M")

# Step 5: Calculate sentence duration
data$sentence_days <- as.numeric(difftime(data$jail_out, data$jail_in, units = "days"))

# Step 6: Remove invalid sentence durations
data <- data[!is.na(data$sentence_days) & data$sentence_days >= 0, ]

# Step 7: Run the t-test
t_result <- t.test(sentence_days ~ sex, data = data)
print(t_result)

# Step 8: Boxplot for visualization
boxplot(sentence_days ~ sex, data = data,
        main = "Sentence Length (Days) by Sex",
        xlab = "Sex", ylab = "Sentence Length (Days)", col = c("lightblue", "pink"))




```
```{r}
# Drop NA or negative sentence lengths
data <- data[!is.na(data$sentence_days) & data$sentence_days >= 0, ]

# Ensure is_recid is numeric (if it's not already, this won't do anything harmful)
data$is_recid <- as.numeric(as.character(data$is_recid))

# Safely convert is_recid to a factor with labeled levels
data$is_recid <- factor(data$is_recid, levels = c(0, 1),
                        labels = c("Not_Reconvicted", "Reconvicted"))

# Confirm the unique values in is_recid
print(unique(data$is_recid))

# Calculate total count by gender
gender_counts <- table(data$sex)

# Calculate proportions (percent of each gender)
gender_proportions <- prop.table(gender_counts)
percentages <- round(100 * gender_proportions, 2)
print(percentages)

# Create recidivism table by gender
recid_table <- table(data$sex, data$is_recid)
print(recid_table)

# Total number of people
total_people <- sum(recid_table)
cat("Total number of people:", total_people, "\n")

# Total by gender
total_by_gender <- rowSums(recid_table)
cat("Total women:", total_by_gender["Female"], "\n")
cat("Total men:", total_by_gender["Male"], "\n")

# Total by recidivism status (optional)
total_by_recid <- colSums(recid_table)
cat("Not Reconvicted:", total_by_recid["Not_Reconvicted"], "\n")
cat("Reconvicted:", total_by_recid["Reconvicted"], "\n")

table(data$sex, data$c_charge_desc)



```
```{r}
# Total charges (rows) by sex
table(data$sex)

table(data$sex, data$c_charge_desc)
library(dplyr)
data %>%
  group_by(sex, c_charge_desc) %>%
  summarise(count = n(), .groups = "drop") %>%
  arrange(sex, desc(count)) %>%
  group_by(sex) %>%
  slice_head(n = 5)
table(data$sex, data$priors_count)  # if that column exists
aggregate(priors_count ~ sex, data, mean)

library(ggplot2)
library(dplyr)

top_charges <- data %>%
  filter(c_charge_desc %in% c("Battery", "Possession of Cocaine", 
                              "Grand Theft in the 3rd Degree", 
                              "Driving While License Revoked", 
                              "Driving Under The Influence", 
                              "arrest case no charge")) %>%
  group_by(sex, c_charge_desc) %>%
  summarise(count = n()) %>%
  ungroup()

ggplot(top_charges, aes(x = reorder(c_charge_desc, count), y = count, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top Charges by Gender", x = "Charge", y = "Count") +
  coord_flip() +
  theme_minimal()


```
```{r}
# Calculate proportion of charges by sex
library(dplyr)

# Get total charges per gender
total_by_gender <- data %>%
  group_by(sex) %>%
  summarise(total = n())

# Get counts of each charge per gender
battery_counts <- data %>%
  filter(c_charge_desc == "Battery") %>%
  group_by(sex) %>%
  summarise(battery = n())

# Merge and calculate percentages
battery_rates <- left_join(battery_counts, total_by_gender, by = "sex") %>%
  mutate(percent_battery = round(100 * battery / total, 2))

print(battery_rates)

```

```{r}
str(data$r_jail_out)
unique(data$r_jail_out[!is.na(data$r_jail_out)][1:10])
aggregate(priors_count ~ sex, data, mean)
model <- lm(sentence_days ~ sex + age + priors_count + c_charge_desc, data = data)
summary(model)


```
```{r}
install.packages("caret", dependencies = TRUE)
summary(model)
library(caret)
step_model <- step(model)
summary(model)

```
```{r}
# Full model (already run by you)
full_model <- lm(sentence_days ~ sex + age + priors_count + c_charge_desc, data = data)

# Stepwise model selection using AIC
reduced_model <- step(full_model, direction = "both")  # both forward and backward selection

# View summary of the reduced model
summary(reduced_model)
```

```{r}
# Full model (already run by you)
full_model <- lm(sentence_days ~ sex + age + priors_count + c_charge_desc, data = data)

# Stepwise model selection using AIC
reduced_model <- step(full_model, direction = "both")  # both forward and backward selection

# View summary of the reduced model
summary(reduced_model)
```
```{r}
library(broom)
library(dplyr)

top_predictors <- tidy(full_model) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value)

head(top_predictors, 5)
# Example based on assumed top predictors
grep("c_charge_desc", colnames(model.matrix(full_model)), value = TRUE)[1:10]

colnames(model.matrix(full_model))
grep("c_charge_desc", colnames(model.matrix(full_model)), value = TRUE)
vars <- grep("c_charge_desc", colnames(model.matrix(full_model)), value = TRUE)
print(vars)
simplified_model <- lm(sentence_days ~ priors_count +
  `c_charge_descCorrupt.Public.Servant` +
  `c_charge_descAggravated.Battery..Firearm.` +
  `c_charge_descAttempted.Robbery.Firearm` +
  `c_charge_descPoss.Alprazolam.W.int.Sell.Del`,
  data = model.frame(full_model))




```

```{r}
simplified_model <- lm(sentence_days ~ priors_count +
  `c_charge_descCorrupt.Public.Servant` +
  `c_charge_descAggravated.Battery..Firearm.` +
  `c_charge_descAttempted.Robbery.Firearm` +
  `c_charge_descPoss.Alprazolam.W.int.Sell.Del`,
  data = model.frame(full_model))
```

